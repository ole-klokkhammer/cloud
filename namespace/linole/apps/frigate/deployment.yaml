apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: frigate
  namespace: linole
  labels:
    app: frigate
spec:
  replicas: 1
  serviceName: frigate
  selector:
    matchLabels:
      app: frigate
  template:
    metadata:
      namespace: linole
      labels:
        app: frigate
    spec:
      containers:
        # https://docs.frigate.video/frigate/installation/
        # https://github.com/blakeblackshear/blakeshome-charts/tree/master/charts/frigate
        - name: frigate
          image: ghcr.io/blakeblackshear/frigate:stable
          securityContext:
            privileged: true # use if coral
          env:
            - name: REOLINK_USER
              valueFrom:
                secretKeyRef:
                  name: frigate-secrets
                  key: REOLINK_USER
            - name: REOLINK_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: frigate-secrets
                  key: REOLINK_PASSWORD
          ports:
            - name: http
              containerPort: 5000
              protocol: TCP
            - name: http-auth
              containerPort: 8971
              protocol: TCP
            - name: rtmp
              containerPort: 1935
              protocol: TCP
            - name: rtsp
              containerPort: 8554
              protocol: TCP
          volumeMounts:
            - mountPath: /dev/bus/usb:/dev/bus/usb
              name: coral-dev
            - mountPath: /config/config.yml
              subPath: config.yml
              name: configmap
            - mountPath: /config
              name: frigate-config
            - mountPath: /media/frigate
              name: frigate-media
      volumes:
        - name: coral-dev
          hostPath:
            path: /dev/bus/usb:/dev/bus/usb
        - name: configmap
          configMap:
            name: frigate
  volumeClaimTemplates:
    - metadata:
        name: frigate-config
        namespace: linole
      spec:
        storageClassName: longhorn-single-replica
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 100Mi
        volumeName: frigate-config
    - metadata:
        name: frigate-media
        namespace: linole
      spec:
        storageClassName: longhorn-single-replica
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 5Gi
        volumeName: frigate-media
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: frigate-config
  namespace: linole
  labels:
    app: frigate
spec:
  storageClassName: longhorn-single-replica
  accessModes:
    - ReadWriteOnce
  capacity:
    storage: 100Mi
  volumeMode: Filesystem
  csi:
    driver: driver.longhorn.io
    fsType: ext4
    volumeHandle: frigate-config
    volumeAttributes:
      numberOfReplicas: "1"
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: frigate-media
  namespace: linole
  labels:
    app: frigate
spec:
  storageClassName: longhorn-single-replica
  accessModes:
    - ReadWriteOnce
  capacity:
    storage: 5Gi
  volumeMode: Filesystem
  csi:
    driver: driver.longhorn.io
    fsType: ext4
    volumeHandle: frigate-media
    volumeAttributes:
      numberOfReplicas: "1"